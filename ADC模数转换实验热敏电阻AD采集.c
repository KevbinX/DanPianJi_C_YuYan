/*******************************************************************************
                                      main.c
*******************************************************************************/
/**************************************************************************************
深圳市普中科技有限公司（PRECHIN 普中）
技术支持：www.prechin.net
PRECHIN
 普中

实验名称：ADC模数转换实验--热敏电阻AD采集
接线说明：	
实验现象：下载程序后，数码管上显示AD模块采集热敏电阻的AD值
注意事项：																				  
***************************************************************************************/
#include "public.h"
#include "smg.h"
#include "xpt2046.h"


/*******************************************************************************
* 函 数 名       : main
* 函数功能		 : 主函数
* 输    入       : 无
* 输    出    	 : 无
*******************************************************************************/
void main() {
    // 初始化变量
    u16 adc_value = 0;
    u8 adc_buf[4];

    // 无限循环，持续读取和显示ADC值
    while (1) {
        // 从 XPT2046 读取 ADC 值
        adc_value = xpt2046_read_adc_value(0xD4); // 测量热敏电阻

        // 将 ADC 值转换为可显示格式
        adc_buf[0] = gsmg_code[adc_value / 1000]; // 获取千位数字
        adc_buf[1] = gsmg_code[adc_value % 1000 / 100]; // 获取百位数字
        adc_buf[2] = gsmg_code[adc_value % 1000 % 100 / 10]; // 获取十位数字
        adc_buf[3] = gsmg_code[adc_value % 1000 % 100 % 10]; // 获取个位数字

        // 显示 ADC 值
        smg_display(adc_buf, 5); // 在数码管上显示ADC值
    }
}


/*******************************************************************************
                                      publi.h
*******************************************************************************/
#ifndef _public_H	// 如果没有定义宏_public_H，则进行以下操作
#define _public_H	// 定义宏_public_H

#include "reg52.h"	// 包含reg52.h头文件

typedef unsigned int u16;	// 重定义无符号整型数据类型u16
typedef unsigned char u8;	// 重定义无符号字符数据类型u8
typedef unsigned long u32;	// 重定义无符号长整型数据类型u32

void delay_10us(u16 ten_us);	// 函数声明，用于延时10微秒
void delay_ms(u16 ms);	// 函数声明，用于延时指定毫秒

#endif	// 结束宏定义部分


/*******************************************************************************
                                      smg.c
*******************************************************************************/
#include "smg.h"

//共阴极数码管显示0~F的段码数据
u8 gsmg_code[17]={0x3f,0x06,0x5b,0x4f,0x66,0x6d,0x7d,0x07,
				0x7f,0x6f,0x77,0x7c,0x39,0x5e,0x79,0x71};

/*******************************************************************************
* 函 数 名       : smg_display
* 函数功能		 : 动态数码管显示
* 输    入       : dat：要显示的数据
				   pos：从左开始第几个位置开始显示，范围1-8
* 输    出    	 : 无
*******************************************************************************/
void smg_display(u8 dat[], u8 pos) {
    // 初始化变量:i 是循环计数器，pos_temp 是调整后的位置
    u8 i = 0;
    u8 pos_temp = pos - 1;

    // 循环显示每个数字
    for (i = pos_temp; i < 8; i++) {
        // 选择当前要显示的数字
        switch (i) { // 位选
            case 0: LSC = 1; LSB = 1; LSA = 1; break; // 选择第一个数码管
            case 1: LSC = 1; LSB = 1; LSA = 0; break; // 选择第二个数码管
            case 2: LSC = 1; LSB = 0; LSA = 1; break; // 选择第三个数码管
            case 3: LSC = 1; LSB = 0; LSA = 0; break; // 选择第四个数码管
            case 4: LSC = 0; LSB = 1; LSA = 1; break; // 选择第五个数码管
            case 5: LSC = 0; LSB = 1; LSA = 0; break; // 选择第六个数码管
            case 6: LSC = 0; LSB = 0; LSA = 1; break; // 选择第七个数码管
            case 7: LSC = 0; LSB = 0; LSA = 0; break; // 选择第八个数码管
        }

        // 发送段选数据到显示器
        SMG_A_DP_PORT = dat[i - pos_temp]; // 发送当前数字的段选数据

        // 等待显示稳定
        delay_10us(100); // 等待一段时间，确保显示稳定

        // 消音
        SMG_A_DP_PORT = 0x00; // 关闭所有段选，消音
    }
}

/*******************************************************************************
                                      smg.h
*******************************************************************************/
#ifndef _smg_H	// 如果没有定义宏_smg_H，则进行以下操作
#define _smg_H	// 定义宏_smg_H

#include "public.h"	// 包含public.h头文件

#define SMG_A_DP_PORT	P0	// 使用宏定义数码管段码口

// 定义数码管位选信号控制脚
sbit LSA=P2^2;
sbit LSB=P2^3;
sbit LSC=P2^4;

extern u8 gsmg_code[17];	// 声明外部变量gsmg_code

void smg_display(u8 dat[],u8 pos);	// 函数声明，用于数码管显示

#endif	// 结束宏定义部分


/*******************************************************************************
                                     xpt2046.c
*******************************************************************************/
#include "xpt2046.h"
#include "intrins.h"

/*******************************************************************************
* 函 数 名       : xpt2046_wirte_data
* 函数功能		   : XPT2046写数据
* 输    入       : dat：写入的数据
* 输    出    	 : 无
*******************************************************************************/
void xpt2046_write_data(u8 dat) {
    // 初始化循环计数器
    u8 i;

    // 准备时钟信号
    CLK = 0;
    _nop_();

    // 按位写入一个字节数据
    for (i = 0; i < 8; i++) { // 循环8次，每次传输一位，共一个字节
        // 先传输高位
        DIN = dat >> 7; // 取出dat的最高位，放入DIN中

        // 将数据左移一位，以便传输下一位
        dat <<= 1; // 左移，准备传输下一位数据

        // 生成时钟脉冲以写入数据
        CLK = 0; // 产生下降沿，准备写入数据
        _nop_();
        CLK = 1; // 产生上升沿，写入数据
        _nop_();
    }
}


/*******************************************************************************
* 函 数 名      : xpt2046_read_data
* 函数功能		 	: XPT2046读数据
* 输    入      : 无
* 输    出    	: XPT2046返回12位数据
*******************************************************************************/
u16 xpt2046_read_data(void) {
    // 初始化循环计数器
    u8 i;

    // 初始化数据变量来存储读取的数据
    u16 dat = 0;

    // 准备时钟信号
    CLK = 0;
    _nop_();

    // 按位读取数据
    for (i = 0; i < 12; i++) { // 循环12次，每次读取一位，大于一个字节数，所以返回值类型是u16
        // 将数据左移一位，以便存储下一位
        dat <<= 1; // 左移，为下一位数据腾出位置

        // 生成时钟脉冲以读取数据
        CLK = 1; // 产生上升沿，准备读取数据
        _nop_();
        CLK = 0; // 产生下降沿，读取数据
        _nop_();

        // 从 DOUT 引脚读取数据位
        dat |= DOUT; // 读取DOUT引脚的数据位，存入dat中
    }

    // 返回读取的数据
    return dat;
}


/*******************************************************************************
* 函 数 名       : xpt2046_read_adc_value
* 函数功能		   : XPT2046读AD数据
* 输    入       : cmd：指令
* 输    出    	 : XPT2046返回AD值
*******************************************************************************/
u16 xpt2046_read_adc_value(u8 cmd) {
    // 初始化变量
    u8 i;
    u16 adc_value = 0;

    // 准备时钟和芯片选择信号
    CLK = 0; // 先拉低时钟
    CS  = 0; // 使能 XPT2046

    // 发送命令到 XPT2046
    xpt2046_write_data(cmd); // 发送命令给 XPT2046

    // 等待转换完成
    for (i = 6; i > 0; i--); // 等待一段时间，等待转换完成

    // 发送一个时钟脉冲以清除Busy信号
    CLK = 1; // 产生时钟上升沿
    _nop_();
    CLK = 0; // 产生时钟下降沿

    // 从 XPT2046 读取ADC值
    adc_value = xpt2046_read_data(); // 读取ADC值

    // 禁用 XPT2046
    CS = 1; // 关闭 XPT2046

    // 返回 ADC 值
    return adc_value;
}

/*******************************************************************************
                                     xpt2046.h
*******************************************************************************/
#ifndef _xpt2046_H	// 如果没有定义宏_xpt2046_H，则进行以下操作
#define _xpt2046_H	// 定义宏_xpt2046_H

#include "public.h"	// 包含public.h头文件

// 管脚定义
sbit DOUT = P3^7;	// 输出
sbit CLK  = P3^6;	// 时钟
sbit DIN  = P3^4;	// 输入
sbit CS   = P3^5;	// 片选

// 函数声明
u16 xpt2046_read_adc_value(u8 cmd);	// 函数声明，用于读取ADC值

#endif	// 结束宏定义部分

